<template>
  <div class="min-h-screen bg-soft-blue-50 p-4 sm:p-6 md:p-8">
    <h1 class="text-3xl sm:text-4xl font-bold text-soft-blue-800 text-center mb-8 sm:mb-10">服務項目管理</h1>

    <div class="max-w-6xl mx-auto bg-white rounded-2xl shadow-lg p-6 sm:p-8 md:p-10 border border-soft-blue-200">
      <div class="flex flex-col md:flex-row justify-between items-center mb-6 space-y-4 md:space-y-0 md:space-x-4">
        <button @click="showModal(null)"
          class="px-5 py-2 bg-soft-blue-600 text-white rounded-full shadow-md hover:bg-soft-blue-700 transition duration-300 text-base sm:text-lg">
          新增服務項目
        </button>
        <div class="flex flex-wrap justify-center sm:justify-end gap-2">
          <button @click="bulkAction('activate')" :disabled="selectedServices.length === 0 || isLoading"
            class="px-3 py-1 bg-green-500 text-white rounded-full text-xs sm:text-sm hover:bg-green-600 transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
            {{ isLoading ? '處理中...' : '批量上架' }}
          </button>
          <button @click="bulkAction('deactivate')" :disabled="selectedServices.length === 0 || isLoading"
            class="px-3 py-1 bg-yellow-500 text-white rounded-full text-xs sm:text-sm hover:bg-yellow-600 transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
            {{ isLoading ? '處理中...' : '批量下架' }}
          </button>
          <button @click="bulkAction('delete')" :disabled="selectedServices.length === 0 || isLoading"
            class="px-3 py-1 bg-red-500 text-white rounded-full text-xs sm:text-sm hover:bg-red-600 transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
            {{ isLoading ? '處理中...' : '批量刪除' }}
          </button>
        </div>
      </div>

      <div class="overflow-x-auto">
        <table class="min-w-full bg-white rounded-xl overflow-hidden">
          <thead class="bg-soft-blue-200">
            <tr>
              <th class="py-2 sm:py-3 px-3 sm:px-4 text-left text-soft-blue-800 font-semibold text-xs sm:text-sm">
                <input type="checkbox" @change="toggleSelectAll" :checked="isAllSelected">
              </th>
              <th class="py-2 sm:py-3 px-3 sm:px-4 text-left text-soft-blue-800 font-semibold text-xs sm:text-sm">圖片</th>
              <th class="py-2 sm:py-3 px-3 sm:px-4 text-left text-soft-blue-800 font-semibold text-xs sm:text-sm">服務名稱</th>
              <th class="py-2 sm:py-3 px-3 sm:px-4 text-left text-soft-blue-800 font-semibold text-xs sm:text-sm">類別</th>
              <th class="py-2 sm:py-3 px-3 sm:px-4 text-left text-soft-blue-800 font-semibold text-xs sm:text-sm">價格</th>
              <th class="py-2 sm:py-3 px-3 sm:px-4 text-left text-soft-blue-800 font-semibold text-xs sm:text-sm">時長範圍 (分)</th>
              <th class="py-2 sm:py-3 px-3 sm:px-4 text-left text-soft-blue-800 font-semibold text-xs sm:text-sm">狀態</th>
              <th class="py-2 sm:py-3 px-3 sm:px-4 text-left text-soft-blue-800 font-semibold text-xs sm:text-sm">操作</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="service in services" :key="service.id" class="border-b border-soft-blue-100 last:border-b-0 hover:bg-soft-blue-50">
              <td class="py-2 sm:py-3 px-3 sm:px-4">
                <input type="checkbox" v-model="selectedServices" :value="service.id">
              </td>
              <td class="py-2 sm:py-3 px-3 sm:px-4">
                <img :src="service.imageUrl || 'https://via.placeholder.com/50?text=Service'" :alt="service.name"
                  class="w-10 h-10 sm:w-12 sm:h-12 object-cover rounded-md">
              </td>
              <td class="py-2 sm:py-3 px-3 sm:px-4 text-soft-blue-700 text-xs sm:text-sm">{{ service.name }}</td>
              <td class="py-2 sm:py-3 px-3 sm:px-4 text-soft-blue-700 text-xs sm:text-sm">{{ service.category }}</td>
              <td class="py-2 sm:py-3 px-3 sm:px-4 text-soft-blue-700 text-xs sm:text-sm">NT$ {{ service.price }}</td>
              <td class="py-2 sm:py-3 px-3 sm:px-4 text-soft-blue-700 text-xs sm:text-sm">{{ service.minDuration }} - {{ service.maxDuration }}</td>
              <td class="py-2 sm:py-3 px-3 sm:px-4">
                <span :class="[service.isActive ? 'bg-green-200 text-green-800' : 'bg-red-200 text-red-800']"
                  class="px-2 py-0.5 rounded-full text-xs font-medium">
                  {{ service.isActive ? '上架中' : '已下架' }}
                </span>
              </td>
              <td class="py-2 sm:py-3 px-3 sm:px-4 flex flex-col sm:flex-row space-y-1 sm:space-y-0 sm:space-x-2">
                <button @click="showModal(service)" :disabled="isLoading"
                  class="px-3 py-1 bg-blue-500 text-white rounded-full text-xs hover:bg-blue-600 transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
                  編輯
                </button>
                <button @click="toggleStatus(service)" :disabled="isLoading"
                  :class="[service.isActive ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-green-500 hover:bg-green-600']"
                  class="px-3 py-1 text-white rounded-full text-xs transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
                  {{ service.isActive ? '下架' : '上架' }}
                </button>
              </td>
            </tr>
            <tr v-if="services.length === 0">
              <td colspan="8" class="py-6 sm:py-8 text-center text-soft-blue-600 text-base sm:text-lg">目前沒有服務項目。</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- 新增/編輯服務的 Modal -->
      <div v-if="isModalOpen" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-xl p-6 sm:p-8 w-full max-w-md relative border border-soft-blue-200">
          <button @click="closeModal" class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 text-2xl sm:text-3xl font-bold">&times;</button>
          <h2 class="text-2xl sm:text-3xl font-bold text-soft-blue-800 mb-5 sm:mb-6">{{ currentService.id ? '編輯' : '新增' }}服務</h2>
          <form @submit.prevent="saveService">
            <div class="mb-3 sm:mb-4">
              <label for="service-name" class="block text-soft-blue-700 text-sm sm:text-base font-bold mb-2">服務名稱 <span class="text-red-500">*</span></label>
              <input type="text" id="service-name" v-model="currentService.name" placeholder="服務名稱" required
                class="shadow appearance-none border border-soft-blue-300 rounded-xl w-full py-2 sm:py-3 px-3 sm:px-4 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-soft-blue-400">
            </div>
            <div class="mb-3 sm:mb-4">
              <label for="service-description" class="block text-soft-blue-700 text-sm sm:text-base font-bold mb-2">描述</label>
              <textarea id="service-description" v-model="currentService.description" rows="3" placeholder="服務詳細描述"
                class="shadow appearance-none border border-soft-blue-300 rounded-xl w-full py-2 sm:py-3 px-3 sm:px-4 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-soft-blue-400"></textarea>
            </div>
            <div class="mb-3 sm:mb-4">
              <label for="service-category" class="block text-soft-blue-700 text-sm sm:text-base font-bold mb-2">類別</label>
              <select id="service-category" v-model="currentService.category"
                class="shadow appearance-none border border-soft-blue-300 rounded-xl w-full py-2 sm:py-3 px-3 sm:px-4 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-soft-blue-400">
                <option value="">請選擇</option>
                <option value="手部護理">手部護理</option>
                <option value="美睫">美睫</option>
                <option value="頭皮護理">頭皮護理</option>
                <option value="臉部護理">臉部護理</option>
                <option value="足部護理">足部護理</option>
              </select>
            </div>
            <div class="mb-3 sm:mb-4">
              <label for="service-price" class="block text-soft-blue-700 text-sm sm:text-base font-bold mb-2">價格 <span class="text-red-500">*</span></label>
              <input type="number" id="service-price" v-model="currentService.price" placeholder="價格" required
                class="shadow appearance-none border border-soft-blue-300 rounded-xl w-full py-2 sm:py-3 px-3 sm:px-4 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-soft-blue-400">
            </div>
            <div class="mb-3 sm:mb-4 flex space-x-4">
              <div class="flex-1">
                <label for="service-min-duration" class="block text-soft-blue-700 text-sm sm:text-base font-bold mb-2">最短時長 (分鐘) <span class="text-red-500">*</span></label>
                <input type="number" id="service-min-duration" v-model="currentService.minDuration" placeholder="最短時長" required
                  class="shadow appearance-none border border-soft-blue-300 rounded-xl w-full py-2 sm:py-3 px-3 sm:px-4 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-soft-blue-400">
              </div>
              <div class="flex-1">
                <label for="service-max-duration" class="block text-soft-blue-700 text-sm sm:text-base font-bold mb-2">最長時長 (分鐘) <span class="text-red-500">*</span></label>
                <input type="number" id="service-max-duration" v-model="currentService.maxDuration" placeholder="最長時長" required
                  class="shadow appearance-none border border-soft-blue-300 rounded-xl w-full py-2 sm:py-3 px-3 sm:px-4 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-soft-blue-400">
              </div>
            </div>
            <div class="mb-5 sm:mb-6">
              <label for="service-image" class="block text-soft-blue-700 text-sm sm:text-base font-bold mb-2">圖片 URL</label>
              <input type="text" id="service-image" v-model="currentService.imageUrl" placeholder="圖片 URL"
                class="shadow appearance-none border border-soft-blue-300 rounded-xl w-full py-2 sm:py-3 px-3 sm:px-4 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-soft-blue-400">
            </div>
            <div class="mb-5 sm:mb-6 flex items-center">
              <input type="checkbox" id="service-active" v-model="currentService.isActive" class="mr-2 leading-tight h-4 w-4 text-soft-blue-600 focus:ring-soft-blue-500 border-gray-300 rounded">
              <label for="service-active" class="text-soft-blue-700 text-sm sm:text-base">上架</label>
            </div>
            <button type="submit" :disabled="isLoading"
              class="w-full bg-soft-blue-600 hover:bg-soft-blue-700 text-white font-bold py-2 sm:py-3 px-3 sm:px-4 rounded-xl focus:outline-none focus:shadow-outline transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
              {{ isLoading ? '儲存中...' : (currentService.id ? '儲存變更' : '新增服務') }}
            </button>
            <button v-if="currentService.id" @click="deleteService(currentService.id)" type="button" :disabled="isLoading"
              class="w-full mt-3 sm:mt-4 bg-red-500 hover:bg-red-600 text-white font-bold py-2 sm:py-3 px-3 sm:px-4 rounded-xl focus:outline-none focus:shadow-outline transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
              {{ isLoading ? '刪除中...' : '刪除服務' }}
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, computed, onMounted } from 'vue';
import { useNotification } from '../../composables/useNotification';
import { fetchServices, saveService as apiSaveService, updateServiceStatus, deleteServiceApi, bulkServiceAction } from '../../api'; // 引入 API 函數，並將 saveService 重新命名為 apiSaveService

const services = ref([]); // 初始化為空陣列
const isModalOpen = ref(false);
const currentService = ref({});
const selectedServices = ref([]); // 用於批量操作
const isLoading = ref(false); // 新增載入狀態

const { showSuccess, showError } = useNotification(); // 使用通知組合式函數

// 組件掛載時載入數據
onMounted(async () => {
  try {
    services.value = await fetchServices(); // 調用 API 函數
  } catch (error) {
    console.error('載入服務失敗:', error);
    showError('載入服務失敗，請稍後再試。');
  }
});

const isAllSelected = computed(() => {
  return services.value.length > 0 && selectedServices.value.length === services.value.length;
});

function toggleSelectAll() {
  if (isAllSelected.value) {
    selectedServices.value = [];
  } else {
    selectedServices.value = services.value.map(s => s.id);
  }
}

function showModal(service) {
  currentService.value = service ? { ...service } : { id: null, name: '', description: '', price: null, minDuration: null, maxDuration: null, category: '', isActive: true, imageUrl: '' };
  isModalOpen.value = true;
}

function closeModal() {
  isModalOpen.value = false;
  currentService.value = {}; // 清空
}

async function saveService() { // 本地函數
  if (!currentService.value.name || !currentService.value.price || currentService.value.minDuration === null || currentService.value.maxDuration === null) {
    showError('請填寫服務名稱、價格、最短時長和最長時長。');
    return;
  }

  if (currentService.value.minDuration > currentService.value.maxDuration) {
    showError('最短時長不能大於最長時長。');
    return;
  }

  isLoading.value = true; // 開始載入
  try {
    const savedService = await apiSaveService(currentService.value); // 調用 API 函數 apiSaveService

    if (currentService.value.id) {
      // 編輯現有服務
      const index = services.value.findIndex(s => s.id === savedService.id);
      if (index !== -1) {
        services.value[index] = { ...savedService };
        showSuccess('服務已更新！');
      }
    } else {
      // 新增服務
      services.value.push({ ...savedService });
      showSuccess('服務已新增！');
    }
    closeModal();
  } catch (error) {
    console.error('儲存服務失敗:', error);
    showError('儲存服務失敗，請稍後再試。');
  } finally {
    isLoading.value = false; // 結束載入
  }
}

async function toggleStatus(service) {
  isLoading.value = true; // 開始載入
  try {
    await updateServiceStatus(service.id, !service.isActive); // 調用 API 函數
    service.isActive = !service.isActive;
    showSuccess(`服務 "${service.name}" 已${service.isActive ? '上架' : '下架'}！`);
  } catch (error) {
    console.error('切換服務狀態失敗:', error);
    showError('切換服務狀態失敗，請稍後再試。');
  } finally {
    isLoading.value = false; // 結束載入
  }
}

async function deleteService(id) {
  if (confirm('您確定要刪除此服務嗎？')) {
    isLoading.value = true; // 開始載入
    try {
      await deleteServiceApi(id); // 調用 API 函數
      services.value = services.value.filter(s => s.id !== id);
      showSuccess('服務已刪除！');
      closeModal();
    } catch (error) {
      console.error('刪除服務失敗:', error);
      showError('刪除服務失敗，請稍後再試。');
    } finally {
      isLoading.value = false; // 結束載入
    }
  }
}

async function bulkAction(action) {
  if (selectedServices.value.length === 0) {
    showError('請選擇至少一項服務。');
    return;
  }

  let confirmMessage = '';
  let successMessage = '';

  if (action === 'activate') {
    confirmMessage = `您確定要上架選定的 ${selectedServices.value.length} 項服務嗎？`;
    successMessage = '選定服務已批量上架！';
  } else if (action === 'deactivate') {
    confirmMessage = `您確定要下架選定的 ${selectedServices.value.length} 項服務嗎？`;
    successMessage = '選定服務已批量下架！';
  } else if (action === 'delete') {
    confirmMessage = `您確定要刪除選定的 ${selectedServices.value.length} 項服務嗎？此操作不可逆！`;
    successMessage = '選定服務已批量刪除！';
  }

  if (confirm(confirmMessage)) {
    isLoading.value = true; // 開始載入
    try {
      await bulkServiceAction(action, selectedServices.value); // 調用 API 函數
      // 重新載入數據以反映批量操作的結果
      services.value = await fetchServices();
      selectedServices.value = []; // 清空選中
      showSuccess(successMessage);
    } catch (error) {
      console.error('批量操作失敗:', error);
      showError('批量操作失敗，請稍後再試。');
    } finally {
      isLoading.value = false; // 結束載入
    }
  }
}
</script>

<style scoped>
/* 這裡可以放置 ServiceManagement 特有的樣式，但盡量使用 Tailwind CSS */
</style>
